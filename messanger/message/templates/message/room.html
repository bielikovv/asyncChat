{% extends 'base.html' %}


{% block content %}
<div class="container">
  <div class="columns is-multiline">
    <div class="column is-6 is-offset-3">
      <div class="card" >
        <div class="card-body" id="card-title-room">
          <h5 class="card-title" >Online chat</h5>
          <br>
          <h6 class="card-subtitle mb-2">Start chatting</h6>
        </div>
      </div>
    </div>

    <div class="column is-6 is-offset-3">
      <div class="box">
        <div id="chat-messages" style="max-height: 300px; overflow-y: scroll; background-color: #ffffff" >
          {% for m in messages %}{{ m.user }}: {{ m.value }}<br>{% endfor %}
        </div>
      </div>

      <div class="field">
        <div class="input-group input-group-sm mb-3">
          <input type="text" id='chat-message-input' class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm">
        </div>
      </div>

      <div class="field">
        <div class="control">
          <button type="submit" id='chat-message-submit' class="btn btn-dark">Отправить</button>
        </div>
      </div>

      <small class="has-text-grey-light">Your username: {{ username }}</small>
    </div>
  </div>
</div>

{{ room_name|json_script:"json-roomname"}}
{{ username|json_script:"json-username"}}
<script>
  const roomName = JSON.parse(document.getElementById("json-roomname").textContent);
  const userName = JSON.parse(document.getElementById("json-username").textContent);

  const chatSocket = new WebSocket(
          'ws://'
          + window.location.host
          +'/ws/'
          +roomName
          +'/'
  );

  chatSocket.onmessage = function (e) {
    console.log('onMessage')

  };

  chatSocket.onclose = function (e) {
    console.error('The socket closed unexpectedly')
  };

  chatSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);


    if (data.message) {
      document.querySelector('#chat-messages').innerHTML += ('<br>' + data.username + ': ' + data.message + ' ');
    } else {
      alert('The message was empty!')
    }
  };

  document.querySelector('#chat-message-input').focus();
  document.querySelector('#chat-message-input').onkeyup = function(e) {
    if (e.keyCode === 13) {
      document.querySelector('#chat-message-submit').click();
    }
  };

  document.querySelector('#chat-message-submit').onclick = function(e) {
    const messageInputDom = document.querySelector('#chat-message-input');
    const message = messageInputDom.value;

    chatSocket.send(JSON.stringify(
            {
              'message': message,
              'username': userName,
              'room': roomName
            }
    ));
    messageInputDom.value = '';
  };

  function scrollToBotoom() {
    let objDiv = document.getElementById("chat-messages");
    objDiv.scrollTop = objDiv.scrollHeight;
  }
  scrollToBotoom();
</script>
{% endblock %}

